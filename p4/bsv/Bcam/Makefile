#!/usr/bin/make -f
#
# This file was automatically generated by makemakefile on Fri May  9 15:07:06 2008
#
CONNECTALDIR=/home/hwang/dev/connectal/
QUARTUS_SIM_LIB=/home/hwang/altera/14.0/quartus/eda/sim_lib/

BSC=bsc
BSCFLAGS=-keep-fires -cross-info
SUFFIXES=

BSVPATH=$(CONNECTALDIR)/bsv:$(CONNECTALDIR)/lib/bsv:../../../hw/bsv/:../AsymmetricBRAM/:bdir:simdir

TOPMOD = mkTb
TOPFILE = Tb.bsv
TOPPACK = $(basename $(TOPFILE))
SIMULATOR = bluesim

FILENAME = .lastmakesim

SRCS = *.bsv
LASTSIM := $(shell cat $(FILENAME) 2>/dev/null)

ifdef SIM
SIMULATOR := $(SIM)
endif

# This means that there is a new sim type, force an update
ifneq ($(LASTSIM), $(SIM))
.PHONY:	$(TOPPACK).bo
endif

# An override on the Make commandline, remember this
ifdef SIM
FILECMD = @echo $(SIM) > $(FILENAME)
else
FILECMD = $(shell rm $(FILENAME)  2>/dev/null)
endif

#ifeq ($(USE_BUILDCACHE),1)
#BUILDCACHE?=$(CONNECTALDIR)/../buildcache/buildcache
#BUILDCACHE_CACHEDIR?=$(CONNECTALDIR)/../fpgamake-cache/$(shell basename `/bin/pwd`)/$(PROJECTDIR)
#CONNECTALFLAGS += --cache=$(BUILDCACHE_CACHEDIR)
#endif

#CONNECTALFLAGS += -v

RUN_BSC = BUILDCACHE_CACHEDIR=$(BUILDCACHE_CACHEDIR) BSC_VSIM_FLAGS=$(BSC_VSIM_FLAGS) $(BUILDCACHE) bsc -p +:$(BSVPATH)
CONNECTALFLAGS += -show-range-conflict +RTS -K46777216 -RTS -demote-errors G0066:G0045 -suppress-warnings G0046:G0020:G0023:S0015:S0080:S0039 -steps-max-intervals 20

# Bluesim and Verilog simulators use two very different bsc calls
ifeq ($(SIMULATOR),bluesim)
CMD1 =	$(RUN_BSC) $(BSCFLAGS) $(CONNECTALFLAGS) -D SIMULATION -sim -g $(TOPMOD) -bdir bdir -simdir simdir -u $(TOPFILE)
CMD2 =	$(RUN_BSC) $(BSCFLAGS) $(CONNECTALFLAGS) -D SIMULATION -sim -o $@ -bdir bdir -simdir simdir -e $(TOPMOD) bdir/$(TOPMOD).ba mem_model.o
else
CMD1 =	$(RUN_BSC) $(BSCFLAGS) $(CONNECTALFLAGS) -u -verilog -g $(TOPMOD) $(TOPFILE)
CMD2 =	$(RUN_BSC) $(BSCFLAGS) $(CONNECTALFLAGS) -verilog -vsim $(SIMULATOR) -e $(TOPMOD) -o $@ $(TOPMOD).v
endif

ifeq (modelsim, $(SIM))
BSC_VSIM_FLAGS+=$(QUARTUS_SIM_LIB)/altera_mf.v
endif

.PHONY: help
help:
	@echo "Possible targets:"
	@echo "  build         --  compile $(TOPFILE) for the default simulator ($(SIMULATOR))"
	@echo "  link          --  Link compiled files for default simulator ($(SIMULATOR))"
	@echo "  run           --  build, link, and simulate using default ($(SIMULATOR)) simulator"
	@echo "  clean         --  remove binary, executable and temporary files"
	@echo "  help          --  display this message"
	@echo " override the default simulator: make build SIM=modelsim"

# ----------------------------------------------------------------
# Executing with Bluesim simulation

.PHONY: build
build:	$(TOPPACK).bo
	vlib altera_mf
	vlog -work altera_mf $(QUARTUS_SIM_LIB)/altera_mf.v

mem_model.o: ../AsymmetricBRAM/mem_model.c
	echo "compiling $@"
	$(CC) -fPIC -c $< -o $@

# compile and link the whole system
$(TOPPACK).bo: $(SRCS) mem_model.o Makefile 
	$(FILECMD)
	mkdir -p bdir simdir
	$(CMD1)


.PHONY: link
link:	$(TOPMOD)

$(TOPMOD): $(TOPPACK).bo
	$(CMD2)

# run (simulate) the system
run:	$(TOPMOD)
ifeq ($(SIMULATOR), bluesim)
	./$(TOPMOD) -m 1500
else
	./$(TOPMOD) +bscvcd +bsccycle 
endif

.PHONY: clean
clean:
	rm -f  *.bi *.bo *.ba *.info *.sched *.c *.h *.o *.so  mk*.v *.cxx  *~ $(TOPMOD) v95/* >/dev/null
	rm -rf bdir simdir
